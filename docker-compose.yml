services:
  postgres:
    container_name: mypostgres
    image: postgres:16.4
    restart: on-failure
    volumes:
      - ./db-data:/var/lib/postgresql/data/
    environment:
       POSTGRES_DB: keycloak_db
       POSTGRES_USER: keycloak
       POSTGRES_PASSWORD: keycloakpassword
       POSTGRES_HOST_AUTH_METHOD: scram-sha-256
       POSTGRES_INITDB_ARGS: --auth-host=scram-sha-256
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - 5432:5432
    networks:
      - backend
  pgadmin:
    container_name: pgadmin_container
    image: dpage/pgadmin4
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - 5050:80
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks: 
      - backend
    depends_on:
       postgres:
        condition: service_started
    restart: 
      on-failure
  keycloak:
    container_name: keycloak_identity
    build:
      context: .
      dockerfile: ./KeyCloakDockerfile/Dockerfile
    
    environment:
      KC_DB_URL_HOST: postgres
      KC_DB: postgres 
      KC_DB_URL_DATABASE: keycloak_db
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloakpassword
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
      KC_HOSTNAME: localhost
      KC_HOSTNAME_STRICT_BACKCHANNEL: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_TRANSACTION_XA_ENABLED: "true" # default: true
      QUARKUS_TRANSACTION_MANAGER_ENABLE_RECOVERY: "true"
      KC_DB_URL:  jdbc:postgresql://postgres:5432/keycloak_db
      KC_HTTP_ENABLED: "true"
      KC_LOG_LEVEL: info
      KC_METRICS_ENABLED: "true"
    depends_on:
       postgres:
          condition: service_healthy 
    ports:
      - 8888:8080
      - 9000:9000
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: http://localhost\r\nConnection: close\r\n\r\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;"] 
      start_period: 10s
      interval: 30s
      retries: 3
      timeout: 5s
    restart: always
    networks :
      - backend
volumes:
  db-data:
    driver: local  
  pgadmin_data:
networks:
  backend:
    name: backend
    driver: bridge
